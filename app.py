import streamlit as st
import io
from datetime import datetime

# --- –õ–æ–≥–∏–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ ---
def process_vcf(input_file):
    output_buffer = io.StringIO()
    
    # –®–∞–ø–∫–∞ –∫–∞–∫ —É 23andMe
    current_date = datetime.now().strftime("%Y-%m-%d")
    output_buffer.write(f"# This data file generated by Genotek-to-23andMe Converter\n")
    output_buffer.write(f"# Date: {current_date}\n")
    output_buffer.write(f"# rsid\tchromosome\tposition\tgenotype\n")
    
    # –ß–∏—Ç–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    stringio = io.StringIO(input_file.getvalue().decode("utf-8"))
    
    stats = {'written': 0, 'skipped': 0}
    
    for line in stringio:
        line = line.strip()
        if not line or line.startswith('#'):
            continue
        
        parts = line.split('\t')
        if len(parts) < 10:
            continue

        # –î–∞–Ω–Ω—ã–µ
        chrom, pos, raw_id, ref, alt = parts[0], parts[1], parts[2], parts[3], parts[4]
        genotype_raw = parts[9]

        # 1. –ß–∏—Å—Ç–∏–º ID
        id_parts = raw_id.split(';')
        clean_rsid = id_parts[0]
        found_rs = False
        for part in id_parts:
            if part.startswith('rs'):
                clean_rsid = part
                found_rs = True
                break
        
        # –ï—Å–ª–∏ ID —ç—Ç–æ —Ç–æ—á–∫–∞ –∏–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ rs ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if clean_rsid == '.' or (not found_rs and clean_rsid == '.'):
            stats['skipped'] += 1
            continue

        # 2. –ß–∏—Å—Ç–∏–º —Ö—Ä–æ–º–æ—Å–æ–º—É
        clean_chrom = chrom.replace('chr', '')
        
        # 3. –§–∏–ª—å—Ç—Ä –ø—É—Å—Ç—ã—Ö
        if '.' in genotype_raw and '0' not in genotype_raw and '1' not in genotype_raw:
            stats['skipped'] += 1
            continue
            
        try:
            separator = '|' if '|' in genotype_raw else '/'
            alleles_indices = genotype_raw.split(':')[0].split(separator)
            possible_bases = [ref] + alt.split(',')
            
            final_genotype = ""
            for index in alleles_indices:
                final_genotype += possible_bases[int(index)]
            
            # 4. –§–∏–ª—å—Ç—Ä –¥–ª–∏–Ω—ã (—Ç–æ–ª—å–∫–æ 1 –∏–ª–∏ 2 –±—É–∫–≤—ã)
            if len(final_genotype) > 2:
                stats['skipped'] += 1
                continue
            
            output_buffer.write(f"{clean_rsid}\t{clean_chrom}\t{pos}\t{final_genotype}\n")
            stats['written'] += 1

        except (ValueError, IndexError):
            stats['skipped'] += 1
            continue
            
    return output_buffer.getvalue(), stats

# --- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ---
st.set_page_config(page_title="DNA Converter", page_icon="üß¨")
st.title("üß¨ Genotek to 23andMe")
st.write("–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç VCF —Ñ–∞–π–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç, –ø–æ–Ω—è—Ç–Ω—ã–π MyHeritage, GEDmatch –∏ –¥—Ä—É–≥–∏–º.")

uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏ .vcf —Ñ–∞–π–ª", type="vcf")

if uploaded_file is not None:
    with st.spinner('–û–±—Ä–∞–±–æ—Ç–∫–∞...'):
        result_txt, statistics = process_vcf(uploaded_file)
    
    st.success(f"–ì–æ—Ç–æ–≤–æ! –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {statistics['written']} —Å—Ç—Ä–æ–∫.")
    
    new_filename = uploaded_file.name.replace('.vcf', '') + "_23andme.txt"
    st.download_button("üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç", data=result_txt, file_name=new_filename)