import streamlit as st
import io
from datetime import datetime

# --- –õ–æ–≥–∏–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ ---
def process_vcf(input_file):
    output_buffer = io.StringIO()
    
    # 1. –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ô –®–ê–ü–ö–ò 23ANDME
    # –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: Sat Nov 29 00:00:00 2025
    current_date = datetime.now().strftime("%a %b %d %H:%M:%S %Y")
    
    output_buffer.write(f"# This file was generated by 23andMe at: {current_date}\n")
    output_buffer.write("#\n")
    output_buffer.write("# This file contains raw genotype data, including data that is not used in 23andMe reports.\n")
    output_buffer.write("# This data is suitable only for research, educational, and informational use and not for medical or other use.\n")
    output_buffer.write("# \n")
    output_buffer.write("# Below is a text version of your data.  Fields are TAB-separated\n")
    output_buffer.write("# Each line corresponds to a single SNP.  For each SNP, we provide its identifier \n")
    output_buffer.write("# (an rsid or an internal id), its location on the reference human genome, and the \n")
    output_buffer.write("# genotype call oriented with respect to the plus strand on the human reference sequence.\n")
    output_buffer.write("# We are using reference human assembly build 37 (also known as Annotation Release 104).\n")
    output_buffer.write("# \n")
    output_buffer.write("# rsid\tchromosome\tposition\tgenotype\n")
    
    # –ß–∏—Ç–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    stringio = io.StringIO(input_file.getvalue().decode("utf-8"))
    
    stats = {
        'written': 0, 
        'skipped_empty': 0,
        'skipped_indel': 0,
        'skipped_no_id': 0,
        'skipped_bad_format': 0
    }
    
    for line in stringio:
        line = line.strip()
        if not line or line.startswith('#'):
            continue
        
        parts = line.split('\t')
        if len(parts) < 10:
            continue

        # –î–∞–Ω–Ω—ã–µ
        chrom, pos, raw_id, ref, alt = parts[0], parts[1], parts[2], parts[3], parts[4]
        genotype_raw = parts[9]

        # 2. –ß–∏—Å—Ç–∏–º ID (—É–¥–∞–ª—è–µ–º –º—É—Å–æ—Ä –∏ –ø—É—Å—Ç—ã–µ —Ç–æ—á–∫–∏)
        id_parts = raw_id.split(';')
        clean_rsid = id_parts[0]
        found_rs = False
        for part in id_parts:
            if part.startswith('rs'):
                clean_rsid = part
                found_rs = True
                break
        
        # –ï—Å–ª–∏ ID —ç—Ç–æ —Ç–æ—á–∫–∞ –∏–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ rs ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if clean_rsid == '.' or (not found_rs and clean_rsid == '.'):
            stats['skipped_no_id'] += 1
            continue

        # 3. –ß–∏—Å—Ç–∏–º —Ö—Ä–æ–º–æ—Å–æ–º—É
        clean_chrom = chrom.replace('chr', '')
        
        # 4. –§–∏–ª—å—Ç—Ä –ø—É—Å—Ç—ã—Ö (./.)
        if '.' in genotype_raw and '0' not in genotype_raw and '1' not in genotype_raw:
            stats['skipped_empty'] += 1
            continue
            
        try:
            separator = '|' if '|' in genotype_raw else '/'
            alleles_indices = genotype_raw.split(':')[0].split(separator)
            possible_bases = [ref] + alt.split(',')
            
            final_genotype = ""
            for index in alleles_indices:
                final_genotype += possible_bases[int(index)]
            
            # 5. –§–∏–ª—å—Ç—Ä –¥–ª–∏–Ω—ã (—Ç–æ–ª—å–∫–æ 1 –∏–ª–∏ 2 –±—É–∫–≤—ã)
            if len(final_genotype) > 2:
                stats['skipped_indel'] += 1
                continue
            
            output_buffer.write(f"{clean_rsid}\t{clean_chrom}\t{pos}\t{final_genotype}\n")
            stats['written'] += 1

        except (ValueError, IndexError):
            stats['skipped_bad_format'] += 1
            continue
            
    return output_buffer.getvalue(), stats

# --- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ---
st.set_page_config(page_title="Genotek to 23andMe", page_icon="üß¨")
st.title("üß¨ Genotek to 23andMe Converter")
st.write("–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç VCF —Ñ–∞–π–ª—ã Genotek –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç 23andMe (build 37).")

uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏ .vcf —Ñ–∞–π–ª", type="vcf")

if uploaded_file is not None:
    with st.spinner('–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è...'):
        result_txt, statistics = process_vcf(uploaded_file)
    
    st.success(f"–ì–æ—Ç–æ–≤–æ! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {statistics['written']} —Å—Ç—Ä–æ–∫ SNP.")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ (–º–æ–∂–Ω–æ —Å–≤–µ—Ä–Ω—É—Ç—å)
    with st.expander("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—á–∏—Å—Ç–∫–∏"):
        st.write(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å—Ç—Ä–æ–∫: {statistics['written']}")
        st.write(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ –±–µ–∑ ID: {statistics['skipped_no_id']}")
        st.write(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ –ø—É—Å—Ç—ã—Ö (./.): {statistics['skipped_empty']}")
        st.write(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ –¥–ª–∏–Ω–Ω—ã—Ö –º—É—Ç–∞—Ü–∏–π (Indels): {statistics['skipped_indel']}")

    new_filename = uploaded_file.name.replace('.vcf', '') + "_23andme.txt"
    st.download_button("üì• –°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª", data=result_txt, file_name=new_filename)
